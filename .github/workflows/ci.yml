name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  # ─── Build once, share everywhere ─────────────────────────────
  build:
    name: Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Clear webpack cache (prevents build hangs)
        run: rm -rf node_modules/.cache

      - name: Build plugin
        run: npm run build

      - name: Verify build output
        run: |
          echo "Checking build output..."
          ls -lh build/

          if [ ! -f "build/frontend.js" ]; then
            echo "❌ build/frontend.js not found"
            exit 1
          fi

          if [ ! -f "build/style-index.css" ]; then
            echo "❌ build/style-index.css not found"
            exit 1
          fi

          index_chunks=$(ls build/index*.js 2>/dev/null | wc -l)
          if [ "$index_chunks" -eq 0 ]; then
            echo "❌ No index chunks found (build/index*.js)"
            exit 1
          fi

          echo "✅ Build successful - found $index_chunks index chunks, frontend.js, and style-index.css"

      - name: Check bundle sizes
        run: |
          echo "Checking bundle sizes..."
          max_chunk=100000  # 100 KB max per chunk
          max_css=70000     # 70 KB max for CSS

          for js_file in build/index*.js; do
            if [ -f "$js_file" ]; then
              js_size=$(stat -c%s "$js_file" 2>/dev/null || stat -f%z "$js_file")
              filename=$(basename "$js_file")
              if [ $js_size -gt $max_chunk ]; then
                echo "⚠️ $filename is ${js_size} bytes (max: ${max_chunk})"
              else
                echo "✅ $filename is ${js_size} bytes"
              fi
            fi
          done

          if [ -f "build/frontend.js" ]; then
            js_size=$(stat -c%s build/frontend.js 2>/dev/null || stat -f%z build/frontend.js)
            if [ $js_size -gt $max_chunk ]; then
              echo "⚠️ build/frontend.js is ${js_size} bytes (max: ${max_chunk})"
            else
              echo "✅ build/frontend.js is ${js_size} bytes"
            fi
          fi

          if [ -f "build/style-index.css" ]; then
            css_size=$(stat -c%s build/style-index.css 2>/dev/null || stat -f%z build/style-index.css)
            if [ $css_size -gt $max_css ]; then
              echo "⚠️ build/style-index.css is ${css_size} bytes (max: ${max_css})"
            else
              echo "✅ build/style-index.css is ${css_size} bytes"
            fi
          fi

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: build/
          retention-days: 1

  # ─── JS/CSS lint + unit tests (no PHP needed, runs once) ─────
  lint-and-test:
    name: Lint & Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run JavaScript linter
        run: npm run lint:js --if-present || echo "⚠️ JS linting not configured"

      - name: Run CSS linter
        run: npm run lint:css --if-present || echo "⚠️ CSS linting not configured"

      - name: Run JavaScript unit tests
        run: npm run test:unit -- --ci

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

  # ─── PHP lint & static analysis (matrix only where needed) ───
  lint-php:
    name: PHP ${{ matrix.php-version }} Lint & Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read

    strategy:
      matrix:
        php-version: ['8.0', '8.1', '8.2', '8.3']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          tools: composer
          coverage: none

      - name: PHP syntax check
        run: |
          errors=0
          while IFS= read -r file; do
            if ! php -l "$file" > /dev/null 2>&1; then
              php -l "$file"
              errors=$((errors + 1))
            fi
          done < <(git ls-files '*.php' ':!vendor')
          if [ "$errors" -gt 0 ]; then
            echo "Found $errors PHP file(s) with syntax errors"
            exit 1
          fi
          echo "All PHP files pass syntax check"

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Run PHP linter (PHPCS)
        run: composer run-script lint

      - name: Run PHPStan static analysis
        run: composer run-script analyse

  # ─── Security audit ──────────────────────────────────────────
  security-check:
    name: Security Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=critical

  # ─── Dependency review (PR only) ─────────────────────────────
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: critical

  # ─── E2E tests (reuses build artifact) ───────────────────────
  e2e-tests:
    name: E2E Tests
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: build/

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Start wp-env
        run: npm run wp-env start

      - name: Wait for WordPress to be ready
        run: |
          echo "Waiting for WordPress..."
          for i in $(seq 1 30); do
            if curl -s -o /dev/null -w '%{http_code}' http://localhost:8888/wp-login.php | grep -q '200'; then
              echo "WordPress is ready (attempt $i)"
              break
            fi
            echo "Not ready yet (attempt $i/30)..."
            sleep 2
          done

      - name: Run E2E tests (Chromium)
        run: npm run test:e2e -- --project=setup --project=chromium
        env:
          CI: true

      - name: Stop wp-env
        if: always()
        run: npm run wp-env stop

      - name: Upload E2E test artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-test-results
          path: |
            artifacts/
            playwright-report/
          retention-days: 7

  # ─── Dynamic matrix for WordPress compatibility ──────────────
  setup-wp-matrix:
    name: Setup WP Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - name: Determine matrix
        id: set-matrix
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # PRs: test boundary pairs (oldest + newest) for fast feedback
            echo 'matrix={"include":[{"php":"8.0","wordpress":"6.7"},{"php":"8.3","wordpress":"latest"}]}' >> $GITHUB_OUTPUT
          else
            # Main push: full matrix for comprehensive coverage
            echo 'matrix={"php":["8.0","8.1","8.2","8.3"],"wordpress":["6.7","6.8","6.9","latest"]}' >> $GITHUB_OUTPUT
          fi

  wordpress-compatibility:
    name: WordPress ${{ matrix.wordpress }} / PHP ${{ matrix.php }}
    needs: [build, setup-wp-matrix]
    runs-on: ubuntu-latest
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.setup-wp-matrix.outputs.matrix) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Setup PHP ${{ matrix.php }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer

      - name: Install dependencies
        run: |
          npm ci
          composer install --no-interaction --prefer-dist

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: build/

      - name: Configure wp-env for WordPress ${{ matrix.wordpress }}
        run: |
          cat > .wp-env.override.json <<EOF
          {
            "core": "WordPress/WordPress#${{ matrix.wordpress == 'latest' && 'master' || matrix.wordpress }}",
            "phpVersion": "${{ matrix.php }}",
            "themes": [ "https://downloads.wordpress.org/theme/twentytwentyfour.1.3.zip" ],
            "plugins": [ "." ]
          }
          EOF
          cat .wp-env.override.json

      - name: Start wp-env
        run: npm run wp-env start

      - name: Check WordPress version
        run: |
          npx wp-env run cli wp core version
          npx wp-env run cli wp plugin list

      - name: Run PHP tests in WordPress environment
        run: |
          npx wp-env run tests-cli --env-cwd=wp-content/plugins/designsetgo vendor/bin/phpunit

      - name: Check plugin activation
        run: |
          npx wp-env run cli wp plugin activate designsetgo
          npx wp-env run cli wp plugin list --status=active

      - name: Stop wp-env
        if: always()
        run: npm run wp-env stop
