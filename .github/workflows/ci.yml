name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    permissions:
      contents: read   # Required for actions/checkout
      actions: write   # Required for actions/upload-artifact

    strategy:
      matrix:
        node-version: [20.x]
        php-version: [8.0, 8.1, 8.2]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          tools: composer
          coverage: none

      - name: Install dependencies
        run: npm ci

      - name: Clear webpack cache (prevents build hangs)
        run: rm -rf node_modules/.cache

      - name: Build plugin
        run: npm run build

      - name: Check build output
        run: |
          echo "Checking build output..."
          ls -lh build/

          # Check for essential build artifacts
          if [ ! -f "build/frontend.js" ]; then
            echo "❌ build/frontend.js not found"
            exit 1
          fi

          if [ ! -f "build/style-index.css" ]; then
            echo "❌ build/style-index.css not found"
            exit 1
          fi

          # Check that index chunks were created (due to code splitting)
          index_chunks=$(ls build/index*.js 2>/dev/null | wc -l)
          if [ "$index_chunks" -eq 0 ]; then
            echo "❌ No index chunks found (build/index*.js)"
            exit 1
          fi

          echo "✅ Build successful - found $index_chunks index chunks, frontend.js, and style-index.css"

      - name: Run JavaScript linter
        run: npm run lint:js --if-present || echo "⚠️ JS linting not configured"

      - name: Run CSS linter
        run: npm run lint:css --if-present || echo "⚠️ CSS linting not configured"

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Run PHP linter (PHPCS)
        run: composer run-script lint

      - name: Run PHPStan static analysis
        run: composer run-script analyse

      - name: Run JavaScript unit tests
        run: npm run test:unit -- --coverage --ci

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: matrix.php-version == '8.2'
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

      - name: Check file sizes
        run: |
          echo "Checking bundle sizes..."
          max_chunk=100000  # 100 KB max per chunk (code splitting allows multiple chunks)
          max_css=70000     # 70 KB max for CSS

          # Check all index chunks (code splitting may create multiple)
          for js_file in build/index*.js; do
            if [ -f "$js_file" ]; then
              js_size=$(stat -c%s "$js_file" 2>/dev/null || stat -f%z "$js_file")
              filename=$(basename "$js_file")
              if [ $js_size -gt $max_chunk ]; then
                echo "⚠️ $filename is ${js_size} bytes (max: ${max_chunk})"
              else
                echo "✅ $filename is ${js_size} bytes"
              fi
            fi
          done

          # Check frontend.js
          if [ -f "build/frontend.js" ]; then
            js_size=$(stat -c%s build/frontend.js 2>/dev/null || stat -f%z build/frontend.js)
            if [ $js_size -gt $max_chunk ]; then
              echo "⚠️ build/frontend.js is ${js_size} bytes (max: ${max_chunk})"
            else
              echo "✅ build/frontend.js is ${js_size} bytes"
            fi
          fi

          # Check CSS
          if [ -f "build/style-index.css" ]; then
            css_size=$(stat -c%s build/style-index.css 2>/dev/null || stat -f%z build/style-index.css)
            if [ $css_size -gt $max_css ]; then
              echo "⚠️ build/style-index.css is ${css_size} bytes (max: ${max_css})"
            else
              echo "✅ build/style-index.css is ${css_size} bytes"
            fi
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-php-${{ matrix.php-version }}
          path: build/
          retention-days: 7

  security-check:
    name: Security Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read   # Required for actions/checkout

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=critical

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write   # Required for actions/upload-artifact

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Build plugin
        run: npm run build

      - name: Run E2E tests (Chromium)
        run: npm run test:e2e -- --project=setup --project=chromium
        env:
          CI: true

      - name: Upload E2E test artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-test-results
          path: artifacts/
          retention-days: 7

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: critical

  wordpress-compatibility:
    name: WordPress ${{ matrix.wordpress }} / PHP ${{ matrix.php }}
    runs-on: ubuntu-latest
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        php: ['8.0', '8.2']
        wordpress: ['6.7', '6.8', '6.9', 'latest']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Setup PHP ${{ matrix.php }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer

      - name: Install dependencies
        run: |
          npm ci
          composer install --no-interaction --prefer-dist

      - name: Build plugin
        run: npm run build

      - name: Configure wp-env for WordPress ${{ matrix.wordpress }}
        run: |
          # Create custom .wp-env.override.json for this WP version
          cat > .wp-env.override.json <<EOF
          {
            "core": "WordPress/WordPress#${{ matrix.wordpress == 'latest' && 'master' || matrix.wordpress }}",
            "phpVersion": "${{ matrix.php }}",
            "themes": [ "https://downloads.wordpress.org/theme/twentytwentyfour.1.3.zip" ],
            "plugins": [ "." ]
          }
          EOF
          cat .wp-env.override.json

      - name: Start wp-env
        run: npm run wp-env start

      - name: Check WordPress version
        run: |
          npx wp-env run cli wp core version
          npx wp-env run cli wp plugin list

      - name: Run PHP tests in WordPress environment
        run: |
          # Run tests inside wp-env (using vendor/bin/phpunit directly since Composer isn't in the container)
          npx wp-env run tests-cli --env-cwd=wp-content/plugins/designsetgo vendor/bin/phpunit

      - name: Check plugin activation
        run: |
          npx wp-env run cli wp plugin activate designsetgo
          npx wp-env run cli wp plugin list --status=active

      - name: Stop wp-env
        if: always()
        run: npm run wp-env stop
